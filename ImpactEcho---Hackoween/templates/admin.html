<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ImpactEcho — Admin Dashboard</title>
  <link rel="stylesheet" href="/static/style2.css" />
  <style>
    .tabs{
      display:flex;
      gap:16px;
      margin-bottom:32px;
      border-bottom:2px solid rgba(139,92,246,0.2);
      padding-bottom:16px;
    }
    .tab{
      background:rgba(255,255,255,0.05);
      border:2px solid rgba(139,92,246,0.2);
      padding:12px 24px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      color:#94a3b8;
      transition:all 0.2s ease;
    }
    .tab:hover{
      background:rgba(139,92,246,0.1);
      transform:translateY(-2px);
    }
    .tab.active{
      background:linear-gradient(135deg,var(--neon-pink) 0%,var(--neon-purple) 100%);
      color:white;
      border-color:transparent;
    }
    .tab-content{
      display:none;
    }
    .tab-content.active{
      display:block;
    }
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:20px;
      margin-bottom:32px;
    }
    .stat-card{
      background:rgba(10,14,39,0.6);
      border:2px solid rgba(139,92,246,0.2);
      border-radius:16px;
      padding:24px;
      text-align:center;
    }
    .stat-value{
      font-size:36px;
      font-weight:900;
      background:linear-gradient(135deg,var(--neon-pink),var(--neon-purple));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .stat-label{
      color:#94a3b8;
      font-size:14px;
      margin-top:8px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      background:rgba(10,14,39,0.6);
      border-radius:12px;
      overflow:hidden;
    }
    thead{
      background:rgba(139,92,246,0.2);
    }
    th,td{
      padding:16px;
      text-align:left;
      border-bottom:1px solid rgba(139,92,246,0.1);
    }
    th{
      font-weight:700;
      color:#ffffff;
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:1px;
    }
    td{
      color:#cbd5e1;
      font-size:14px;
    }
    tr:hover{
      background:rgba(139,92,246,0.05);
    }
    .address{
      font-family:monospace;
      font-size:12px;
      color:var(--neon-blue);
    }
    .timestamp{
      color:#94a3b8;
      font-size:12px;
    }
    .amount{
      color:var(--neon-green);
      font-weight:700;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="logo">💖</span><span class="brand-name">ImpactEcho Admin</span>
    </div>
    <nav class="nav-right">
      <span id="adminName" style="color:#cbd5e1;margin-right:16px;"></span>
      <button onclick="window.location.href='/admin-logout'" class="btn-link">Logout</button>
    </nav>
  </header>

  <main class="container">
    <section class="card" style="max-width:100%;margin:30px auto;">
      <h2 style="margin-bottom:32px;">Admin Dashboard</h2>
      
      <!-- Stats Grid -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalLogins">0</div>
          <div class="stat-label">Total Logins</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalDonations">0</div>
          <div class="stat-label">Total Donations</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalAmount">₹0</div>
          <div class="stat-label">Total Amount</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab('users')">Users</div>
        <div class="tab" onclick="switchTab('logins')">Login Logs</div>
        <div class="tab" onclick="switchTab('donations')">Donation Logs</div>
        <div class="tab" onclick="switchTab('ngo-requests')">NGO Requests</div>
        <div class="tab" onclick="switchTab('organizations')">Organizations</div>
        <div class="tab" onclick="switchTab('cause-requests')">Cause Requests</div>
        <div class="tab" onclick="switchTab('causes')">Add Cause</div>
      </div>

      <!-- Users Tab -->
      <div class="tab-content active" id="users-tab">
        <h3 style="margin-bottom:20px;">Registered Users</h3>
        <div style="overflow-x:auto;">
          <table id="usersTable">
            <thead>
              <tr>
                <th>Wallet Address</th>
                <th>Joined Date</th>
                <th>Total Donations</th>
                <th>Total Amount</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr><td colspan="4" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Login Logs Tab -->
      <div class="tab-content" id="logins-tab">
        <h3 style="margin-bottom:20px;">Login Activity</h3>
        <div style="overflow-x:auto;">
          <table id="loginsTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>User Type</th>
                <th>Identifier</th>
              </tr>
            </thead>
            <tbody id="loginsBody">
              <tr><td colspan="3" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Donation Logs Tab -->
      <div class="tab-content" id="donations-tab">
        <h3 style="margin-bottom:20px;">Donation History</h3>
        <div style="overflow-x:auto;">
          <table id="donationsTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Wallet Address</th>
                <th>Cause</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="donationsBody">
              <tr><td colspan="4" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- NGO Requests Tab -->
      <div class="tab-content" id="ngo-requests-tab">
        <h3 style="margin-bottom:20px;">Pending NGO Registrations</h3>
        <div id="ngoRequestsContainer"></div>
      </div>

      <!-- Organizations Tab -->
      <div class="tab-content" id="organizations-tab">
        <h3 style="margin-bottom:20px;">Approved Organizations</h3>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Unique ID</th>
                <th>Organization Name</th>
                <th>Email</th>
                <th>Contact Person</th>
                <th>Phone</th>
                <th>Approved Date</th>
              </tr>
            </thead>
            <tbody id="orgsBody">
              <tr><td colspan="6" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Cause Requests Tab -->
      <div class="tab-content" id="cause-requests-tab">
        <h3 style="margin-bottom:20px;">NGO Cause Requests</h3>
        <div id="causeRequestsContainer"></div>
      </div>

      <!-- Add Cause Tab -->
      <div class="tab-content" id="causes-tab">
        <h3 style="margin-bottom:20px;">Add New Cause</h3>
        <form id="addCauseForm">
          <label>Title</label>
          <input type="text" id="title" class="input" required />

          <label>Description</label>
          <textarea id="description" class="input" required></textarea>

          <label>Goal Amount (₹)</label>
          <input type="number" id="goal" class="input" required />

          <label>Image URL</label>
          <input type="text" id="image" class="input" required />

          <button type="submit" class="fund-btn" style="margin-top:15px;">Add Cause</button>
        </form>
        <p id="message" class="muted small" style="margin-top:10px;"></p>
      </div>
    </section>
  </main>

  <script>
    let currentTab = 'users';

    function switchTab(tab) {
      currentTab = tab;
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tab + '-tab').classList.add('active');
    }

    async function loadData() {
      try {
        const res = await fetch('/api/admin/data');
        const data = await res.json();
        
        // Update stats
        document.getElementById('totalUsers').textContent = data.users.length;
        document.getElementById('totalLogins').textContent = data.login_logs.length;
        document.getElementById('totalDonations').textContent = data.donation_logs.length;
        const totalAmount = data.donation_logs.reduce((sum, log) => sum + log.amount, 0);
        document.getElementById('totalAmount').textContent = `₹${totalAmount.toLocaleString()}`;
        
        // Load users
        loadUsers(data.users);
        
        // Load login logs
        loadLoginLogs(data.login_logs);
        
        // Load donation logs
        loadDonationLogs(data.donation_logs);
      } catch (err) {
        console.error('Error loading data:', err);
      }
    }

    async function loadNGOData() {
      try {
        const res = await fetch('/api/admin/ngo-data');
        const data = await res.json();
        
        // Load NGO requests
        loadNGORequests(data.registrations);
        
        // Load organizations
        loadOrganizations(data.registrations.filter(r => r.status === 'approved'));
        
        // Load cause requests
        loadCauseRequests(data.cause_requests);
      } catch (err) {
        console.error('Error loading NGO data:', err);
      }
    }

    function loadNGORequests(regs) {
      const container = document.getElementById('ngoRequestsContainer');
      const pending = regs.filter(r => r.status === 'pending');
      
      if (pending.length === 0) {
        container.innerHTML = '<p style="color:#94a3b8;">No pending requests</p>';
        return;
      }
      
      container.innerHTML = pending.map(r => `
        <div style="background:rgba(10,14,39,0.6);border:2px solid rgba(139,92,246,0.2);border-radius:16px;padding:24px;margin-bottom:20px;">
          <h3 style="margin-bottom:12px;">${r.org_name}</h3>
          <p><strong>Email:</strong> ${r.email}</p>
          <p><strong>Contact Person:</strong> ${r.person_name}</p>
          <p><strong>Phone:</strong> ${r.contact}</p>
          <p><strong>Submitted:</strong> ${new Date(r.submitted_at).toLocaleString()}</p>
          ${r.files.length > 0 ? `<p><strong>Files:</strong> ${r.files.map(f => `<a href="/uploads/${f}" target="_blank" style="color:var(--neon-blue);">${f}</a>`).join(', ')}</p>` : ''}
          <button onclick="approveNGO(${r.id})" style="margin-top:12px;padding:10px 20px;background:linear-gradient(135deg,var(--neon-pink),var(--neon-purple));color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;">Approve & Assign ID</button>
        </div>
      `).join('');
    }

    async function approveNGO(id) {
      if (!confirm('Approve this NGO registration?')) return;
      try {
        const res = await fetch(`/admin-approve-ngo/${id}`, {method: 'POST'});
        const data = await res.json();
        if (data.success) {
          alert(`Approved! Unique ID assigned: ${data.unique_id}`);
          loadNGOData();
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function loadOrganizations(orgs) {
      const tbody = document.getElementById('orgsBody');
      if (orgs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">No approved organizations yet</td></tr>';
        return;
      }
      
      tbody.innerHTML = orgs.map(org => `
        <tr>
          <td class="address">${org.unique_id}</td>
          <td><strong>${org.org_name}</strong></td>
          <td>${org.email}</td>
          <td>${org.person_name}</td>
          <td>${org.contact}</td>
          <td class="timestamp">${new Date(org.approved_at).toLocaleString()}</td>
        </tr>
      `).join('');
    }

    function loadCauseRequests(requests) {
      const container = document.getElementById('causeRequestsContainer');
      const pending = requests.filter(r => r.status === 'pending');
      
      if (pending.length === 0) {
        container.innerHTML = '<p style="color:#94a3b8;">No pending cause requests</p>';
        return;
      }
      
      container.innerHTML = pending.map(r => `
        <div style="background:rgba(10,14,39,0.6);border:2px solid rgba(139,92,246,0.2);border-radius:16px;padding:24px;margin-bottom:20px;">
          <h3 style="margin-bottom:12px;">${r.title}</h3>
          <p style="color:#94a3b8;margin-bottom:12px;">${r.description}</p>
          <p><strong>NGO:</strong> ${r.ngo_name}</p>
          <p><strong>Goal:</strong> ₹${r.goal.toLocaleString()}</p>
          <p><strong>Submitted:</strong> ${new Date(r.submitted_at).toLocaleString()}</p>
          <button onclick="approveCause(${r.id})" style="margin-top:12px;padding:10px 20px;background:linear-gradient(135deg,var(--neon-pink),var(--neon-purple));color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;">Approve & Add to Dashboard</button>
        </div>
      `).join('');
    }

    async function approveCause(id) {
      if (!confirm('Approve this cause and add to main dashboard?')) return;
      try {
        const res = await fetch(`/admin-approve-cause/${id}`, {method: 'POST'});
        const data = await res.json();
        if (data.success) {
          alert('Cause approved and added to dashboard!');
          loadNGOData();
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function loadUsers(users) {
      const tbody = document.getElementById('usersBody');
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#94a3b8;">No users yet</td></tr>';
        return;
      }
      
      tbody.innerHTML = users.map(user => `
        <tr>
          <td class="address">${user.wallet_address}</td>
          <td class="timestamp">${new Date(user.joined_date).toLocaleString()}</td>
          <td>${user.total_donations}</td>
          <td class="amount">₹${user.total_amount.toLocaleString()}</td>
        </tr>
      `).join('');
    }

    function loadLoginLogs(logs) {
      const tbody = document.getElementById('loginsBody');
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#94a3b8;">No logs yet</td></tr>';
        return;
      }
      
      // Reverse to show latest first
      const reversedLogs = [...logs].reverse();
      
      tbody.innerHTML = reversedLogs.map(log => `
        <tr>
          <td class="timestamp">${new Date(log.timestamp).toLocaleString()}</td>
          <td>${log.user_type === 'admin' ? '🔐 Admin' : '🦊 Donator'}</td>
          <td class="address">${log.identifier}</td>
        </tr>
      `).join('');
    }

    function loadDonationLogs(logs) {
      const tbody = document.getElementById('donationsBody');
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#94a3b8;">No donations yet</td></tr>';
        return;
      }
      
      // Reverse to show latest first
      const reversedLogs = [...logs].reverse();
      
      tbody.innerHTML = reversedLogs.map(log => `
        <tr>
          <td class="timestamp">${new Date(log.timestamp).toLocaleString()}</td>
          <td class="address">${log.wallet_address}</td>
          <td>${log.cause}</td>
          <td class="amount">₹${log.amount.toLocaleString()}</td>
        </tr>
      `).join('');
    }

    // Add Cause Form
    const form = document.getElementById('addCauseForm');
    const message = document.getElementById('message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        goal: Number(document.getElementById('goal').value),
        image: document.getElementById('image').value.trim()
      };

      try {
        const res = await fetch('/causes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.ok) {
          message.style.color = 'green';
          message.textContent = `Cause "${result.cause.title}" added successfully!`;
          form.reset();
        } else {
          message.style.color = 'red';
          message.textContent = result.error || 'Something went wrong';
        }
      } catch (err) {
        message.style.color = 'red';
        message.textContent = 'Error: ' + err.message;
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      loadNGOData();
      // Refresh data every 10 seconds
      setInterval(() => {
        loadData();
        loadNGOData();
      }, 10000);
    });
  </script>
</body>
</html>
